<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <title>ASS to JSON Converter</title>
    <style>
        body { font-family: sans-serif; margin: 2rem; }
        pre { background: #eee; padding: 1rem; white-space: pre-wrap; word-wrap: break-word; }
        button { margin-top: 1rem; padding: 0.5rem 1rem; font-size: 1rem; }
    </style>
</head>

<body>
    <h1>ASS to JSON Converter</h1>
    <input type="file" id="fileInput" accept=".ass" />
    <button id="saveBtn" style="display:none;">ðŸ’¾ Simpan JSON</button>
    <h3>Output JSON:</h3>
    <pre id="output">[ ]</pre>
    <script>
    let latestResult = [];
    let outputFileName = "output.json";

    document.getElementById("fileInput").addEventListener("change", async function(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Buat nama output dari nama file input
        outputFileName = file.name.replace(/\.ass$/i, '.json');

        const text = await file.text();
        const lines = text.split(/\r?\n/);
        const events = lines.filter((line) => line.startsWith("Dialogue:"));

        const result = [];

        for (const line of events) {
            const fields = line.split(',');
            const start = toSeconds(fields[1]);
            const rawText = fields.slice(9).join(',').trim();

            const regex = /{\\k(\d+)}([^{}]*)/g;
            let currentTime = start;
            let match;

            while ((match = regex.exec(rawText)) !== null) {
                const duration = parseInt(match[1]) * 0.01;
                const word = match[2].replace(/<br>/gi, '<br>').trim();
                if (word) {
                    result.push({
                        word,
                        start: parseFloat(currentTime.toFixed(2)),
                        end: parseFloat((currentTime + duration).toFixed(2))
                    });
                }
                currentTime += duration;
            }
        }

        latestResult = result;
        document.getElementById("output").textContent = JSON.stringify(result, null, 2);
        document.getElementById("saveBtn").style.display = 'inline-block';
    });

    document.getElementById("saveBtn").addEventListener("click", function() {
        const blob = new Blob([JSON.stringify(latestResult, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = outputFileName;
        a.click();
        URL.revokeObjectURL(url);
    });

    function toSeconds(assTime) {
        const [h, m, s] = assTime.split(':');
        const [sec, cs] = s.split('.');
        return parseInt(h) * 3600 + parseInt(m) * 60 + parseInt(sec) + (parseInt(cs) || 0) / 100;
    }
    </script>
</body>

</html>